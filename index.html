<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Custom Values — Bulk Editor</title>
<style>
  :root{
    --bg:#0f1115; --panel:#17191e; --border:#2b2f36; --txt:#fff; --muted:#a1a1aa;
    --accent:#ff8a00; --accent-soft:rgba(255,138,0,.12);
    --good:#34d399; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .app{min-height:100%;display:flex;flex-direction:column}
  .wrap{width:100%;max-width:1200px;margin:0 auto;padding:20px 16px;flex:1;display:flex;flex-direction:column;gap:12px}
  h1{margin:0;font-size:22px}
  .muted{color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px}
  .pad{padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .input,.btn,.select{background:#11151b;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none;min-height:36px}
  .btn{cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#111;border-color:#000}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.6;cursor:default}
  .two{display:grid;grid-template-columns:1fr minmax(420px,1.2fr);gap:12px}
  @media (max-width:980px){ .two{grid-template-columns:1fr} }
  .left .head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--border)}
  .table-wrap{max-height:60vh;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
  thead th{position:sticky;top:0;background:var(--panel);z-index:1}
  tr:hover{background:#0f141a}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#d1d5db}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid transparent}
  .ok{background:rgba(52,211,153,.15);color:#bbf7d0;border-color:rgba(52,211,153,.4)}
  .no{background:rgba(239,68,68,.10);color:#fecaca;border-color:rgba(239,68,68,.4)}
  .sel{outline:2px solid rgba(255,138,0,.25);outline-offset:-2px}
  .editor .head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--border)}
  .edit-table{max-height:60vh;overflow:auto}
  .value-input{width:100%;min-width:200px;background:#0f141a;border:1px solid var(--border);color:var(--txt);border-radius:8px;padding:7px 9px;outline:none}
  .value-input.changed{box-shadow:0 0 0 2px rgba(255,138,0,.25) inset;border-color:var(--accent)}
  .queue .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;gap:8px;align-items:center;background:#11151b;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .chip .x{cursor:pointer;font-weight:900;opacity:.8}
  .queue .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px);z-index:50}
  .spinner{width:68px;height:68px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(255,138,0,.85), transparent 55%),
               radial-gradient(circle at 70% 70%, rgba(255,138,0,.35), transparent 45%), #0b0b0b;
    box-shadow:0 0 24px rgba(255,138,0,.35),0 0 60px rgba(255,138,0,.18) inset,0 0 4px rgba(255,138,0,.7) inset;
    animation:spin 1.1s linear infinite,pulse 1.6s ease-in-out infinite;border:2px solid rgba(255,138,0,.35)}
  @keyframes spin {to{transform:rotate(360deg)}} @keyframes pulse {50%{box-shadow:0 0 36px rgba(255,138,0,.55),0 0 90px rgba(255,138,0,.28) inset,0 0 6px rgba(255,138,0,1) inset}}
</style>
</head>
<body>
<div class="app">
  <div class="wrap">
    <div>
      <h1>Custom Values Viewer</h1>
      <p class="muted">Full-width widget. Read from n8n; edit on the right; queue changes; send only updates.
      URL overrides: ?readUrl=...&writeUrl=...&locationId=...&page=1&pageSize=10&sort=name-asc</p>
    </div>

    <div class="card pad">
      <div class="row">
        <label style="flex:1">
          <div class="muted" style="margin-bottom:4px">Location ID</div>
          <input id="locationId" class="input" placeholder="KH4..." />
        </label>
        <label>
          <div class="muted" style="margin-bottom:4px">Page size</div>
          <select id="pageSize" class="select"><option>10</option><option>20</option><option>50</option></select>
        </label>
        <label>
          <div class="muted" style="margin-bottom:4px">Sort</div>
          <select id="sort" class="select">
            <option value="name-asc">Name A-Z</option>
            <option value="name-desc">Name Z-A</option>
            <option value="key-asc">Key A-Z</option>
            <option value="key-desc">Key Z-A</option>
          </select>
        </label>
        <button id="btnFetch" class="btn primary">Fetch</button>
        <div id="status" class="pill" style="margin-left:auto">Ready.</div>
      </div>
      <div class="row" style="margin-top:10px">
        <label style="flex:1">
          <div class="muted" style="margin-bottom:4px">Search by Display Name</div>
          <input id="search" class="input" placeholder="Type to filter..." />
        </label>
        <div class="row" style="margin-left:auto">
          <button id="btnPrev" class="btn">Prev page</button>
          <button id="btnNext" class="btn">Next page</button>
          <div id="pager" class="pill">-</div>
        </div>
      </div>
    </div>

    <div class="two">
      <div class="card left">
        <div class="head">
          <strong>Results</strong>
          <span id="countInfo" class="muted" style="margin-left:auto"></span>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr class="muted"><th style="width:42%">Display Name</th><th style="width:40%">Field Key</th><th style="width:18%">Has Value?</th></tr></thead>
            <tbody id="listBody"><tr><td colspan="3" class="muted" style="padding:14px">No data. Click Fetch.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card editor">
        <div class="head">
          <strong>Page items (editable)</strong>
          <span class="muted" style="margin-left:auto">Single-line inputs (newlines replaced)</span>
        </div>
        <div class="edit-table">
          <table>
            <thead><tr class="muted"><th style="width:34%">Name</th><th style="width:40%">Field Key</th><th style="width:26%">Value</th></tr></thead>
            <tbody id="editBody"><tr><td colspan="3" class="muted" style="padding:14px">Nothing loaded yet.</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card pad queue">
      <div class="row" style="margin-bottom:8px"><strong>Queued updates</strong><span id="queueCount" class="muted">0 changes</span></div>
      <div id="chips" class="chips"></div>
      <div class="bar">
        <div class="muted">Only changed rows will be sent. Remove any chip to discard that edit.</div>
        <div class="row"><button id="btnClear" class="btn ghost">Clear</button><button id="btnSaveAll" class="btn primary">Save updates</button></div>
      </div>
      <div id="saveMsg" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<div id="overlay" class="overlay" aria-live="polite" aria-busy="true"><div class="spinner" title="Loading"></div></div>

<script>
"use strict";

/* --------- helpers --------- */
var qs = new URLSearchParams(location.search);
function getQS(k, fb){ var v = qs.get(k); if(v==null) return fb||""; try{ return /%[0-9A-F]{2}/i.test(v)?decodeURIComponent(v):v }catch(e){ return v; } }
function toInt(v, fb){ var n = parseInt(v,10); return (Number.isFinite(n)&&n>0)?n:(fb||0); }

var READ_DEFAULT  = "https://api.visquanta.com/webhook/call-custom-values-data";
var WRITE_DEFAULT = "";

var READ_URL  = getQS("readUrl", READ_DEFAULT);
var WRITE_URL = getQS("writeUrl", WRITE_DEFAULT);

function $(id){ return document.getElementById(id); }

var $loc=$("locationId"), $size=$("pageSize"), $sort=$("sort"), $fetch=$("btnFetch");
var $status=$("status"), $pager=$("pager"), $countInfo=$("countInfo");
var $btnPrev=$("btnPrev"), $btnNext=$("btnNext"), $search=$("search");
var $listBody=$("listBody"), $editBody=$("editBody");
var $chips=$("chips"), $queueCount=$("queueCount"), $btnClear=$("btnClear"), $btnSaveAll=$("btnSaveAll"), $saveMsg=$("saveMsg");
var $overlay=$("overlay");

/* --------- state --------- */
var serverPage = Math.max(1, toInt(getQS("page"), 1));
var pageSize   = Math.max(1, toInt(getQS("pageSize"), 10));
var sortKind   = getQS("sort","name-asc");

$size.value = String(pageSize);
$sort.value = sortKind;

var totalCount = 0;
var pageItems  = [];
var filtered   = [];
var edited     = new Map();
var inFlight   = false; // single in-flight request

function showSpin(on){ $overlay.style.display = on ? "flex" : "none"; }
function badge(ok){ return '<span class="badge '+(ok?'ok':'no')+'">'+(ok?'Yes':'No')+'</span>'; }
function setStatus(s){ $status.textContent = s; }

function sanitizeRows(list){
  return list.map(function(r){
    return { name: r && r.name || "", fieldKey: r && r.fieldKey || "", value: (r && (r.value!=null?r.value:null)), id: r && r.id || null };
  });
}
function parsePayload(payload){
  var obj = payload;
  if (Array.isArray(obj)) {
    if (obj[0] && obj[0].json && typeof obj[0].json === "object") obj = obj[0].json;
    else return { items: sanitizeRows(obj), total: obj.length };
  }
  if (obj && obj.json && typeof obj.json === "object") obj = obj.json;
  var subset = (obj && Array.isArray(obj.customValuesSubset) && obj.customValuesSubset) ||
               (obj && Array.isArray(obj.customValues) && obj.customValues) ||
               (obj && Array.isArray(obj.data) && obj.data) || [];
  return { items: sanitizeRows(subset), total: Number((obj && obj.totalCount)!=null?obj.totalCount:subset.length) || 0 };
}

function applyFilter(){
  var q = ($search.value||"").trim().toLowerCase();
  filtered = !q ? pageItems : pageItems.filter(function(r){ return (r.name||"").toLowerCase().indexOf(q) !== -1; });
}

function renderList(){
  $listBody.innerHTML = "";
  if (!filtered.length){ $listBody.innerHTML = '<tr><td colspan="3" class="muted" style="padding:14px">No results.</td></tr>'; return; }
  filtered.forEach(function(row){
    var hasVal = !!(row.value && String(row.value).trim());
    var tr = document.createElement("tr");
    tr.innerHTML = '<td>'+ (row.name||"") +'</td><td class="mono">'+ (row.fieldKey||"") +'</td><td>'+ badge(hasVal) +'</td>';
    tr.addEventListener("click", function(){
      var el = document.querySelector('input[data-key="'+ row.fieldKey +'"]');
      if (el){ el.focus({preventScroll:false}); el.scrollIntoView({block:"center"}); }
      highlightRow(row.fieldKey);
    });
    $listBody.appendChild(tr);
  });
}

function highlightRow(fieldKey){
  Array.prototype.forEach.call($listBody.querySelectorAll("tr"), function(tr){
    if (tr.children[1] && tr.children[1].textContent.trim() === fieldKey.trim()) tr.classList.add("sel"); else tr.classList.remove("sel");
  });
  Array.prototype.forEach.call($editBody.querySelectorAll("tr"), function(tr){
    var cell = tr.querySelector("[data-k]");
    if (cell && cell.getAttribute("data-k") === fieldKey) tr.classList.add("sel"); else tr.classList.remove("sel");
  });
}

function renderEditor(){
  $editBody.innerHTML = "";
  if (!filtered.length){ $editBody.innerHTML = '<tr><td colspan="3" class="muted" style="padding:14px">No items to edit.</td></tr>'; return; }
  filtered.forEach(function(row){
    var tr = document.createElement("tr");
    var initial = edited.has(row.fieldKey) ? edited.get(row.fieldKey).value : (row.value!=null?row.value:"");
    tr.innerHTML =
      '<td>'+ (row.name||"") +'</td>'+
      '<td class="mono" data-k="'+ (row.fieldKey||"") +'">'+ (row.fieldKey||"") +'</td>'+
      '<td><input class="value-input" data-key="'+ (row.fieldKey||"") +'" data-id="'+ (row.id||"") +'" value="'+ String(initial).replace(/"/g,"&quot;") +'" placeholder="(empty)" /></td>';
    var input = tr.querySelector("input.value-input");
    input.addEventListener("input", function(e){
      var clean = e.target.value.replace(/\r?\n/g, " ");
      if (clean !== e.target.value) e.target.value = clean;
      var fv = (clean||"").trim();
      var ov = (row.value!=null?String(row.value):"");
      if (fv !== ov){ input.classList.add("changed"); edited.set(row.fieldKey, { id: row.id, fieldKey: row.fieldKey, value: clean, name: row.name }); }
      else { input.classList.remove("changed"); edited.delete(row.fieldKey); }
      renderQueue();
    });
    $editBody.appendChild(tr);
  });
}

function renderQueue(){
  $chips.innerHTML = "";
  var arr = Array.from(edited.values());
  $queueCount.textContent = arr.length + " change" + (arr.length===1?"":"s");
  if (!arr.length) return;
  arr.forEach(function(u){
    var chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = '<span class="mono" title="'+ u.fieldKey +'">'+ (u.name||u.fieldKey).slice(0,40) +'</span><span class="x" title="Remove">x</span>';
    chip.querySelector(".x").addEventListener("click", function(){
      edited.delete(u.fieldKey);
      var inp = document.querySelector('input[data-key="'+ u.fieldKey +'"]');
      if (inp) inp.classList.remove("changed");
      renderQueue();
    });
    $chips.appendChild(chip);
  });
}

function renderMeta(){
  var totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
  $pager.textContent = "Page " + Math.min(serverPage,totalPages) + " of " + totalPages;
  $countInfo.textContent = "Loaded " + filtered.length + " / page • " + totalCount + " total";
  $btnPrev.disabled = serverPage <= 1;
  $btnNext.disabled = serverPage >= totalPages;
}

/* --------- single in-flight fetch --------- */
async function fetchPage(){
  if (inFlight) { return; }
  inFlight = true;
  var locationId = ($loc.value || getQS("locationId","")).trim();
  pageSize = Math.max(1, parseInt($size.value,10)||10);
  sortKind = $sort.value || "name-asc";

  showSpin(true);
  setStatus("Loading…");
  try{
    console.log("[CV] POST", READ_URL, {locationId, page:serverPage, pageSize, sort:sortKind});
    var res = await fetch(READ_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ locationId, page: serverPage, pageSize, sort: sortKind })
    });
    var txt = await res.text();
    var payload = {};
    try{ payload = txt ? JSON.parse(txt) : {}; }catch(e){}
    if (!res.ok) throw new Error("Read "+res.status+" "+(res.statusText||""));
    var parsed = parsePayload(payload);
    pageItems  = parsed.items;
    totalCount = parsed.total;
    applyFilter(); renderList(); renderEditor(); renderMeta();
    setStatus(pageItems.length ? ("Loaded "+pageItems.length+" item"+(pageItems.length===1?"":"s")+" on this page.") : "No items returned for this page.");
  }catch(e){
    setStatus(e && e.message ? e.message : String(e));
    console.error("[CV] fetch error", e);
  }finally{
    showSpin(false);
    inFlight = false;
  }
}

/* --------- events --------- */
$btnPrev.addEventListener("click", function(){ if (serverPage>1){ serverPage--; fetchPage(); }});
$btnNext.addEventListener("click", function(){ serverPage++; fetchPage(); });
$fetch.addEventListener("click", fetchPage);
$search.addEventListener("input", function(){ applyFilter(); renderList(); renderEditor(); renderMeta(); });

$btnClear.addEventListener("click", function(){
  edited.clear();
  Array.prototype.forEach.call(document.querySelectorAll(".value-input.changed"), function(el){ el.classList.remove("changed"); });
  renderQueue();
});

$btnSaveAll.addEventListener("click", async function(){
  if (!WRITE_URL){ $saveMsg.innerHTML = '<span class="muted">Set writeUrl to enable saving.</span>'; return; }
  var locationId = ($loc.value || getQS("locationId","")).trim();
  var updates = Array.from(edited.values()).map(function(u){ return { id:u.id, fieldKey:u.fieldKey, value:u.value }; });
  if (!updates.length){ $saveMsg.innerHTML = '<span class="muted">No changes to save.</span>'; return; }
  $btnSaveAll.disabled = true; $saveMsg.textContent = "Saving…"; showSpin(true);
  try{
    var res = await fetch(WRITE_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ locationId, updates }) });
    var t = await res.text(); var p={}; try{ p = t?JSON.parse(t):{} }catch(e){}
    if (!res.ok) throw new Error("Write "+res.status);
    updates.forEach(function(u){
      var item = pageItems.find(function(x){ return x.fieldKey===u.fieldKey; });
      if (item) item.value = u.value;
      var inp = document.querySelector('input[data-key="'+ u.fieldKey +'"]');
      if (inp) inp.classList.remove("changed");
    });
    edited.clear(); renderQueue(); renderList();
    $saveMsg.innerHTML = '<span style="color:'+getComputedStyle(document.documentElement).getPropertyValue("--good").trim()+'">Saved '+updates.length+' update'+(updates.length===1?"":"s")+' ✔</span>';
  }catch(e){
    $saveMsg.innerHTML = '<span style="color:'+getComputedStyle(document.documentElement).getPropertyValue("--bad").trim()+'">'+(e && e.message ? e.message : String(e))+'</span>';
  }finally{
    $btnSaveAll.disabled = false; showSpin(false);
  }
});

/* --------- boot --------- */
(function init(){
  var initLoc = getQS("locationId","");
  if (initLoc) $loc.value = initLoc;
  setStatus("Ready.");
  // Optional auto-fetch if locationId present
  // if (initLoc) fetchPage();
})();
</script>
</body>
</html>
