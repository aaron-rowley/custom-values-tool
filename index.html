<!-- BEGIN: Custom Values Viewer -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Values — Pro</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#15181e; --panel-2:#11151b; --border:#2a2f36; --txt:#e7e7ea; --muted:#a1a1aa;
      --accent:#ff8a00; --accent-soft:rgba(255,138,0,.12);
      --good:#34d399; --bad:#ef4444;
      --shadow:0 4px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

    .container{position:fixed;inset:0;display:flex;flex-direction:column}

    .appbar{display:flex;gap:10px;align-items:center;padding:14px 16px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
    .title{font-size:18px;font-weight:700;letter-spacing:.25px}
    .muted{color:var(--muted)}
    .spacer{flex:1}

    .intro{flex:1;display:flex;align-items:center;justify-content:center}
    .intro-card{background:linear-gradient(180deg,rgba(17,21,27,.75),rgba(14,17,22,.75));border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:28px 24px;max-width:560px;width:92%;text-align:center}
    .intro h1{margin:0 0 8px 0;font-size:22px}
    .intro p{margin:0 0 18px 0;color:var(--muted)}
    .btn{cursor:pointer;background:var(--panel-2);color:var(--txt);border:1px solid var(--border);border-radius:12px;min-height:38px;padding:8px 14px;font-weight:700}
    .btn.primary{background:var(--accent);color:#111;border-color:#000;box-shadow:0 0 0 0 rgba(255,138,0,.45);transition:transform .05s ease, box-shadow .2s ease}
    .btn.primary:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(255,138,0,.25)}
    .btn:disabled{opacity:.6;cursor:default}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .input,.select{background:var(--panel-2);color:var(--txt);border:1px solid var(--border);border-radius:10px;min-height:38px;padding:8px 10px;outline:none}

    /* Main area */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:0}
    .table-wrap{flex:1;min-height:0;overflow-y:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:1;background:linear-gradient(0deg,var(--panel),var(--panel));color:var(--muted);font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.3px;border-bottom:1px solid var(--border);padding:10px 12px;text-align:left}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:hover{background:#10151d}
    tbody tr:nth-child(even){background:#0d1218}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#d1d5db}

    .value-input{width:100%;min-width:200px;background:#0f141a;border:1px solid var(--border);color:var(--txt);border-radius:8px;padding:7px 9px;outline:none;transition:box-shadow .2s ease,border-color .2s ease}
    .value-input.changed{box-shadow:0 0 10px 2px rgba(255,138,0,.45),0 0 0 2px rgba(255,138,0,.25) inset;border-color:var(--accent)}

    .drawer{position:sticky;bottom:0;background:var(--panel);border-top:1px solid var(--border);padding:12px 14px;display:flex;gap:10px;align-items:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px;max-height:110px;overflow:auto}
    .chip{display:inline-flex;gap:8px;align-items:center;background:#11151b;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .chip .x{cursor:pointer;font-weight:900;opacity:.85}
    .right{margin-left:auto;display:flex;gap:10px;align-items:center}

    .info-btn{background:transparent;border:1px solid var(--border);color:var(--txt);border-radius:999px;min-height:28px;padding:3px 9px;cursor:pointer}
    .popover{position:absolute;background:#0d1218;border:1px solid var(--border);border-radius:10px;padding:10px 12px;box-shadow:var(--shadow);width:320px;display:none}
    .popover .row{justify-content:flex-start}
    .copy{cursor:pointer;border:1px solid var(--border);border-radius:6px;padding:3px 7px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px);z-index:50}
    .spinner{width:86px;height:86px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(255,138,0,.85), transparent 55%),
                 radial-gradient(circle at 70% 70%, rgba(255,138,0,.35), transparent 45%), #0b0b0b;
      box-shadow:0 0 24px rgba(255,138,0,.35),0 0 60px rgba(255,138,0,.18) inset,0 0 4px rgba(255,138,0,.7) inset;
      animation:spin 1.1s linear infinite,pulse 1.6s ease-in-out infinite;border:2px solid rgba(255,138,0,.35)}
    @keyframes spin {to{transform:rotate(360deg)}}
    @keyframes pulse {50%{box-shadow:0 0 36px rgba(255,138,0,.55),0 0 90px rgba(255,138,0,.28) inset,0 0 6px rgba(255,138,0,1) inset}}

    .hidden{display:none}
  </style>
</head>
<body>
<div class="container">
  <!-- APP BAR -->
  <div class="appbar" id="appbar" style="display:none">
    <div class="title">Custom Values Viewer</div>
    <button id="btnRefresh" class="btn">Refresh</button>
    <label style="margin-left:10px">Show
      <select id="pageSizeSelect" class="select">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>
    </label>

    <!-- Paging controls -->
    <div class="spacer"></div>
    <button id="btnPrev" class="btn" disabled>Prev</button>
    <button id="btnNext" class="btn" disabled>Next</button>
    <label class="muted" style="display:flex;gap:6px;align-items:center;margin-left:8px">
      Page
      <input id="pageJump" class="input" inputmode="numeric" pattern="[0-9]*" style="width:80px" placeholder="#" />
      <button id="btnGo" class="btn">Go</button>
    </label>
    <small class="muted" id="pageInfo" style="margin-left:8px">Page —</small>
    <small class="muted" id="countInfo" style="margin-left:10px">—</small>
  </div>

  <!-- INTRO SCREEN -->
  <div class="intro" id="intro">
    <div class="intro-card">
      <h1>Pull your custom values</h1>
      <p>Fast, friendly editor for GHL custom values. Uses your API webhook and shows only what you need.</p>
      <div class="row">
        <input id="locationId" class="input" placeholder="Location ID (e.g., KH4...)" />
      </div>
      <div class="row">
        <button id="btnPull" class="btn primary">Pull custom values</button>
      </div>
      <div class="row muted" style="font-size:12px">
        <span>Tip: You can also pass <span class="mono">readUrl</span>, <span class="mono">writeUrl</span>, and <span class="mono">authToken</span> via query string.</span>
      </div>
    </div>
  </div>

  <!-- TABLE AREA -->
  <div id="main" class="card" style="margin:12px;display:none;flex:1;min-height:0">
    <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center">
      <strong>Custom Values</strong>
      <div class="spacer"></div>
      <input id="search" class="input" placeholder="Search all pages by display name or key…" style="min-width:260px;width:360px" />
    </div>
    <div class="table-wrap" id="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:42%">Display Name</th>
            <th style="width:46%">Value</th>
            <th style="width:12%">Info</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="muted" style="padding:14px">No data. Click <b>Pull custom values</b>.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Save Drawer -->
    <div class="drawer">
      <strong>Queued updates</strong>
      <span id="queueCount" class="muted">0 changes</span>
      <div class="chips" id="chips"></div>
      <div class="right">
        <button id="btnClear" class="btn">Clear</button>
        <button id="btnSave" class="btn primary">Save updates</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay Spinner -->
<div id="overlay" class="overlay" aria-live="polite" aria-busy="true"><div class="spinner" title="Loading"></div></div>

<script>
"use strict";

// ======== tiny helpers ========
var qs = new URLSearchParams(location.search);
function getQS(k, fb){ var v = qs.get(k); if(v==null) return fb||""; try{ return /%[0-9A-F]{2}/i.test(v)?decodeURIComponent(v):v }catch(e){ return v; } }
function $(id){ return document.getElementById(id); }
function show(el,on){ el.style.display = on?"":"none"; }
function showSpin(on){ $("overlay").style.display = on?"flex":"none"; }
function toInt(v, fb){ var n = parseInt(v,10); return (Number.isFinite(n)&&n>0)?n:(fb||0); }
function debounce(fn,ms){ var t; return function(){ clearTimeout(t); var a=arguments, self=this; t=setTimeout(function(){ fn.apply(self,a); },ms); }; }

// ======== endpoints (URL-overridable) ========
var READ_DEFAULT  = "https://api.visquanta.com/webhook/call-custom-values-data";
var WRITE_DEFAULT = "https://api.visquanta.com/webhook/update-custom-values";
var READ_URL  = getQS("readUrl", READ_DEFAULT);
var WRITE_URL = getQS("writeUrl", WRITE_DEFAULT);
var AUTH_TOKEN = getQS("authToken", "");

// ======== dom ========
var $intro=$("intro"), $main=$("main"), $appbar=$("appbar"),
    $btnPull=$("btnPull"), $loc=$("locationId"), $tbody=$("tbody"),
    $chips=$("chips"), $queueCount=$("queueCount"), $btnClear=$("btnClear"),
    $btnSave=$("btnSave"), $countInfo=$("countInfo"), $search=$("search"),
    $btnRefresh=$("btnRefresh"), $pageSizeSelect=$("pageSizeSelect"),
    $tableWrap=$("tableWrap"), $btnPrev=$("btnPrev"), $btnNext=$("btnNext"),
    $pageInfo=$("pageInfo"), $pageJump=$("pageJump"), $btnGo=$("btnGo");

// ======== state ========
var serverPage = 1;
var totalPages = 1;
var pageSize   = Math.max(1, toInt(getQS("pageSize"), 50));
$pageSizeSelect.value = String(pageSize);
var sortKind   = getQS("sort","name-asc");
var totalCount = 0;
var pageItems  = [];
var filtered   = [];
var edited     = new Map();
var inFlight   = false;
var globalSearchTerm = "";

if (getQS("locationId")) $loc.value = getQS("locationId");

// ======== fetch utils ========
function parsePayload(payload){
  var obj = payload;
  if (Array.isArray(obj)){
    if (obj[0] && obj[0].json && typeof obj[0].json === "object") obj = obj[0].json; else return { items: sanitizeRows(obj), total: obj.length, page: serverPage, pageSize, totalPages: Math.max(1, Math.ceil(obj.length/Math.max(1,pageSize))) };
  }
  if (obj && obj.json && typeof obj.json === "object") obj = obj.json;

  var subset = (obj && Array.isArray(obj.customValuesSubset) && obj.customValuesSubset) ||
               (obj && Array.isArray(obj.customValues) && obj.customValues) ||
               (obj && Array.isArray(obj.data) && obj.data) || [];

  var page     = Number(obj && obj.page) || serverPage || 1;
  var pSize    = Number(obj && obj.pageSize) || pageSize || 50;
  var total    = Number((obj && obj.totalCount)!=null ? obj.totalCount : subset.length) || 0;
  var tPages   = Number(obj && obj.totalPages) || Math.max(1, Math.ceil(total / Math.max(1,pSize)));
  var hasPrev  = (obj && typeof obj.hasPrev === "boolean") ? obj.hasPrev : (page > 1);
  var hasNext  = (obj && typeof obj.hasNext === "boolean") ? obj.hasNext : (page < tPages);
  var prevPage = (obj && obj.prevPage!=null) ? obj.prevPage : (hasPrev ? page - 1 : null);
  var nextPage = (obj && obj.nextPage!=null) ? obj.nextPage : (hasNext ? page + 1 : null);

  return {
    items: sanitizeRows(subset),
    total,
    page,
    pageSize: pSize,
    totalPages: tPages,
    hasPrev, hasNext, prevPage, nextPage
  };
}
function sanitizeRows(list){
  return list.map(function(r){ return { name: r && r.name || "", fieldKey: r && r.fieldKey || "", value: (r && (r.value!=null?r.value:null)), id: r && r.id || null }; });
}

async function fetchPage(){
  if (inFlight) return; inFlight=true; showSpin(true);
  var preserveScroll = $tableWrap.scrollTop;
  try{
    var res = await fetch(READ_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json", ...(AUTH_TOKEN?{Authorization:AUTH_TOKEN}:{}) },
      body: JSON.stringify({ locationId: ($loc.value||"").trim(), page: serverPage, pageSize, sort: sortKind, search: globalSearchTerm })
    });
    if (!res.ok) throw new Error("Read "+res.status+" "+(res.statusText||""));
    var txt = await res.text(); var payload={}; try{ payload = txt?JSON.parse(txt):{} }catch(e){}
    var parsed = parsePayload(payload);

    pageItems  = parsed.items;
    totalCount = parsed.total;
    serverPage = parsed.page;
    pageSize   = parsed.pageSize;
    totalPages = parsed.totalPages;

    // update UI
    applyFilter(); renderTable();
    $countInfo.textContent = totalCount + " total";
    $pageInfo.textContent  = "Page " + serverPage + " of " + totalPages;
    $btnPrev.disabled = !parsed.hasPrev;
    $btnNext.disabled = !parsed.hasNext;
    $btnPrev.dataset.next = parsed.prevPage == null ? "" : String(parsed.prevPage);
    $btnNext.dataset.next = parsed.nextPage == null ? "" : String(parsed.nextPage);
    $pageJump.value = String(serverPage);
    $pageJump.min = "1"; $pageJump.max = String(totalPages);

    show($intro,false); show($appbar,true); show($main,true);
    requestAnimationFrame(function(){ $tableWrap.scrollTop = preserveScroll; });
  }catch(e){ alert(e && e.message ? e.message : String(e)); }
  finally{ showSpin(false); inFlight=false; }
}

// ======== render ========
function applyFilter(){
  // If we’re doing global (server-side) search, we don’t also client-filter.
  if (globalSearchTerm && globalSearchTerm.trim().length > 0){ filtered = pageItems.slice(); return; }
  var q = ($search.value||"").trim().toLowerCase();
  filtered = !q ? pageItems : pageItems.filter(function(r){
    return (r.name||"").toLowerCase().indexOf(q) !== -1;
  });
}
function renderTable(){
  $tbody.innerHTML = "";
  if (!filtered.length){ $tbody.innerHTML = '<tr><td colspan="3" class="muted" style="padding:14px">No results.</td></tr>'; return; }
  filtered.forEach(function(row){
    var tr = document.createElement("tr");
    var initial = edited.has(row.fieldKey) ? edited.get(row.fieldKey).value : (row.value!=null?row.value:"");
    tr.innerHTML =
      '<td>'+ (row.name||"") +'</td>'+
      '<td><input class="value-input'+(edited.has(row.fieldKey)?' changed':'')+'" data-key="'+ (row.fieldKey||"") +'" data-id="'+ (row.id||"") +'" value="'+ String(initial).replace(/"/g,'&quot;') +'" placeholder="(empty)" /></td>'+
      '<td style="position:relative">\n        <button class="info-btn" data-pop="pop-'+(row.fieldKey||"").replace(/[^\w-]+/g,'_')+'">ℹ️</button>\n        <div class="popover" id="pop-'+(row.fieldKey||"").replace(/[^\w-]+/g,'_')+'">\n          <div class="row">\n            <span class="mono">Field Key:</span>\n            <span class="copy" data-copy="'+ (row.fieldKey||"") +'">Copy</span>\n          </div>\n          <div class="mono" style="margin:4px 0 10px 0">'+ (row.fieldKey||"(none)") +'</div>\n          <div class="row">\n            <span class="mono">Row ID:</span>\n            <span class="copy" data-copy="'+ (row.id||"") +'">Copy</span>\n          </div>\n          <div class="mono">'+ (row.id||"(none)") +'</div>\n        </div>\n      </td>';

    var input = tr.querySelector("input.value-input");
    input.addEventListener("input", function(e){
      var clean = e.target.value.replace(/\r?\n/g, " "); if (clean !== e.target.value) e.target.value = clean;
      var fv = (clean||"").trim(); var ov = (row.value!=null?String(row.value):"");
      if (fv !== ov){ input.classList.add("changed"); edited.set(row.fieldKey, { id: row.id, fieldKey: row.fieldKey, value: clean, name: row.name }); }
      else { input.classList.remove("changed"); edited.delete(row.fieldKey); }
      renderQueue();
    });

    var btn = tr.querySelector(".info-btn");
    var popId = btn.getAttribute("data-pop");
    var pop = tr.querySelector("#"+popId);
    btn.addEventListener("click", function(ev){ ev.stopPropagation();
      document.querySelectorAll('.popover').forEach(function(p){ if(p!==pop) p.style.display='none'; });
      pop.style.display = (pop.style.display==='block')?'none':'block';
    });
    pop.addEventListener('click', function(ev){ ev.stopPropagation(); });
    document.addEventListener('click', function(){ pop.style.display='none'; });

    tr.querySelectorAll('[data-copy]').forEach(function(cp){
      cp.addEventListener('click', function(){ navigator.clipboard.writeText(cp.getAttribute('data-copy')||''); cp.textContent='Copied!'; setTimeout(function(){ cp.textContent='Copy'; },900); });
    });

    $tbody.appendChild(tr);
  });
}

function renderQueue(){
  $chips.innerHTML = "";
  var arr = Array.from(edited.values());
  $queueCount.textContent = arr.length + " change" + (arr.length===1?"":"s");
  if (!arr.length) return;
  arr.forEach(function(u){
    var chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = '<span class="mono" title="'+ u.fieldKey +'">'+ (u.name||u.fieldKey).slice(0,44) +'</span><span class="x" title="Remove">×</span>';
    chip.querySelector(".x").addEventListener("click", function(){ edited.delete(u.fieldKey); var inp = document.querySelector('input[data-key="'+ u.fieldKey +'"]'); var item = pageItems.find(function(x){return x.fieldKey===u.fieldKey}); if(inp){ inp.classList.remove("changed"); inp.value = item && item.value!=null?item.value:''; } renderQueue(); });
    $chips.appendChild(chip);
  });
}

// ======== save ========
async function saveAll(){
  var updates = Array.from(edited.values()).map(function(u){ return { id:u.id, fieldKey:u.fieldKey, value:u.value }; });
  if (!updates.length){ alert('No changes to save.'); return; }
  $btnSave.disabled=true; showSpin(true);
  try{
    var res = await fetch(WRITE_URL, { method:"POST", headers:{ "Content-Type":"application/json", ...(AUTH_TOKEN?{Authorization:AUTH_TOKEN}:{}) }, body: JSON.stringify({ locationId: ($loc.value||"").trim(), updates }) });
    if (!res.ok) throw new Error('Write '+res.status+' '+(res.statusText||''));
    var t = await res.text(); var p={}; try{ p = t?JSON.parse(t):{} }catch(e){}
    var explicitOk = (p && (p.ok===true || p.success===true || p.status==='ok' || Array.isArray(p.updated)));
    if (!explicitOk && (!t || t.trim()==='')) throw new Error('No success response body from server.');

    updates.forEach(function(u){ var item = pageItems.find(function(x){ return x.fieldKey===u.fieldKey; }); if (item) item.value = u.value; var inp = document.querySelector('input[data-key="'+ u.fieldKey +'"]'); if (inp) inp.classList.remove('changed'); });
    edited.clear(); renderQueue();
    alert('Saved '+updates.length+' update'+(updates.length===1?'':'s')+' ✔');
  }catch(e){ alert(e && e.message ? e.message : String(e)); }
  finally{ $btnSave.disabled=false; showSpin(false); }
}

// ======== events ========
$btnPull.addEventListener('click', function(){ serverPage=1; fetchPage(); });
$btnRefresh.addEventListener('click', fetchPage);
$pageSizeSelect.addEventListener('change', function(){ pageSize = toInt($pageSizeSelect.value, 50); serverPage = 1; fetchPage(); });
$btnClear.addEventListener('click', function(){
  edited.forEach(function(u){ var inp = document.querySelector('input[data-key="'+u.fieldKey+'"]'); var item = pageItems.find(function(x){return x.fieldKey===u.fieldKey}); if(inp){ inp.classList.remove("changed"); inp.value = item && item.value!=null?item.value:''; } });
  edited.clear(); renderQueue();
});
$btnSave.addEventListener('click', saveAll);

// Global (server-side) search with debounce
$search.addEventListener('input', debounce(function(){
  globalSearchTerm = ($search.value||"").trim();
  serverPage = 1;
  fetchPage();
}, 300));

// Paging buttons
$btnPrev.addEventListener('click', function(){
  if ($btnPrev.disabled) return;
  var np = toInt($btnPrev.dataset.next, serverPage-1) || (serverPage-1);
  serverPage = Math.max(1, np);
  fetchPage();
});
$btnNext.addEventListener('click', function(){
  if ($btnNext.disabled) return;
  var np = toInt($btnNext.dataset.next, serverPage+1) || (serverPage+1);
  serverPage = Math.min(totalPages, np);
  fetchPage();
});

// Jump-to-page
$btnGo.addEventListener('click', function(){
  var np = Math.min(Math.max(1, toInt($pageJump.value, serverPage)), totalPages);
  if (np !== serverPage){ serverPage = np; fetchPage(); }
});
$pageJump.addEventListener('keydown', function(e){
  if (e.key === 'Enter'){ e.preventDefault(); $btnGo.click(); }
});

// Keyboard shortcuts
window.addEventListener('keydown', function(e){
  var k = e.key.toLowerCase();
  if ((e.metaKey || e.ctrlKey) && k==='s'){ e.preventDefault(); saveAll(); }
  if ((e.metaKey || e.ctrlKey) && k==='r'){ e.preventDefault(); fetchPage(); }
});
</script>
</body>
</html>
<!-- END: Custom Values Viewer -->
